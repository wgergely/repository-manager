# Phase 4: Golden File Rehabilitation

**Priority**: P3 (test hygiene)
**Audit ID**: TH-4
**Domain**: `test-fixtures/expected/`, `crates/repo-core/tests/fixture_tests.rs`
**Status**: Not started
**Prerequisite**: [Phase 3](2026-02-22-test-health-phase3-format-validation.md) (format validators serve as secondary checks)
**Estimated scope**: 3 golden files regenerated from spec, 1 test file updated

---

## Testing Mandate

> **Inherited from [tasks/_index.md](../tasks/_index.md).** Read and internalize the
> full Testing Mandate before modifying any test file.

**Domain-specific enforcement:**
- Golden files must be **authored from tool documentation**, not generated by the code
  under test. A golden file that was generated by `ToolSyncer` and then compared against
  `ToolSyncer` output is tautological — it encodes bugs as expectations.
- After rehabilitation, each golden file must have a header comment documenting its
  provenance (which tool docs / spec it was derived from).
- The fixture tests must **fail** when the code produces malformed output.

---

## Problem Statement

`crates/repo-core/tests/fixture_tests.rs` compares generated output against golden
files in `test-fixtures/expected/`. But the golden files were generated by the same
`ToolSyncer` code being tested. If the code introduces a format regression, the golden
file has the same regression, and the test passes.

See: [Test Health Audit TH-4](../audits/2026-02-22-test-health-audit.md#finding-th-4-self-referential-golden-files)

---

## Implementation Plan

### Step 1: Audit current golden files against tool documentation

For each golden file, determine what the **tool actually expects**:

| Golden File | Tool | Documentation Source |
|-------------|------|---------------------|
| `test-fixtures/expected/cursor/.cursorrules` | Cursor | Cursor docs: plain Markdown or MDC format |
| `test-fixtures/expected/claude/CLAUDE.md` | Claude Code | Claude Code docs: Markdown with natural language |
| `test-fixtures/expected/aider/.aider.conf.yml` | Aider | Aider docs: YAML config with specific keys |

**Actions:**
1. Read each tool's official documentation for config file format requirements
2. Document the expected format in a comment at the top of each golden file
3. Identify any deviations between current golden files and tool requirements

### Step 2: Rewrite golden files from tool specifications

For each golden file, create a new version based on what the tool actually expects,
not what the code currently generates. The golden file should represent **correct output**
as defined by the tool's format specification.

**`test-fixtures/expected/cursor/.cursorrules`:**
```markdown
<!-- repo:block:coding-standards -->
[Content from test-fixtures/repos/config-test/.repository/rules/coding-standards.md]
<!-- /repo:block:coding-standards -->
```

Requirements from Cursor:
- Plain Markdown or MDC format
- HTML comments are valid in Markdown (markers are fine)
- No specific required structure beyond readable text

**`test-fixtures/expected/claude/CLAUDE.md`:**
```markdown
<!-- repo:block:coding-standards -->
[Content from test-fixtures/repos/config-test/.repository/rules/coding-standards.md]
<!-- /repo:block:coding-standards -->
```

Requirements from Claude Code:
- Markdown with natural language instructions
- HTML comments are valid

**`test-fixtures/expected/aider/.aider.conf.yml`:**

Requirements from Aider:
- Valid YAML
- Aider uses YAML comment syntax (`#`) for non-config content
- Block markers must use `#` prefix, not `<!-- -->`

### Step 3: Add provenance headers to golden files

Each golden file should contain a header comment documenting:
- What tool format it represents
- Where the format requirements come from
- When it was last validated against the tool

Example for Markdown files:
```markdown
<!-- Golden file: .cursorrules format for Cursor IDE -->
<!-- Format source: Cursor documentation (plain Markdown / MDC) -->
<!-- Last validated: 2026-02-22 -->
<!-- WARNING: Do not regenerate from code. Edit manually from spec. -->
```

Example for YAML files:
```yaml
# Golden file: .aider.conf.yml format for Aider
# Format source: Aider documentation (YAML config)
# Last validated: 2026-02-22
# WARNING: Do not regenerate from code. Edit manually from spec.
```

### Step 4: Update `fixture_tests.rs` to be more specific

**File:** `crates/repo-core/tests/fixture_tests.rs`

Current tests use full-file string comparison (`assert_eq!`). This is brittle — any
whitespace or ordering change breaks the test even if the output is semantically correct.

Update to use **structural comparison** where possible:

```rust
#[test]
fn test_golden_file_cursor_output_matches_expected() {
    // ... generate output ...

    // Structural checks (survive formatting changes)
    assert!(generated.contains("<!-- repo:block:coding-standards -->"));
    assert!(generated.contains("<!-- /repo:block:coding-standards -->"));
    assert!(generated.contains("rustfmt")); // Rule content
    assert!(generated.contains("clippy"));  // Rule content

    // Block marker count matches
    let open = generated.matches("<!-- repo:block:").count();
    let close = generated.matches("<!-- /repo:block:").count();
    assert_eq!(open, close);

    // Full comparison as secondary check (will be updated if formatting changes)
    assert_eq!(
        normalize_line_endings(&generated).trim(),
        normalize_line_endings(&expected).trim(),
    );
}
```

### Step 5: Add a CI guardrail comment to golden files

Add to `test-fixtures/expected/README.md` (new file):

```markdown
# Golden Test Fixtures

These files represent **expected output** for tool config generation.

## Rules

1. **Never regenerate from code.** Golden files are authored from tool
   documentation, not from running the code under test.
2. **Update manually** when tool format requirements change.
3. **Each file must have a provenance header** documenting the format source.
4. **If a golden file test fails**, investigate whether the code change
   broke the output format or whether the golden file needs updating.
   Do not blindly update the golden file to match new output.
```

---

## Acceptance Criteria

- [ ] Each golden file has a provenance header (format source, last validated date)
- [ ] Golden files are validated against tool documentation (not just code output)
- [ ] `test-fixtures/expected/README.md` exists with guardrail rules
- [ ] `fixture_tests.rs` includes structural checks alongside full comparison
- [ ] Any format deviations found during audit are documented as issues
- [ ] `cargo test -p repo-core` passes
- [ ] `cargo clippy` clean

---

## Files to Modify

| File | Change |
|------|--------|
| `test-fixtures/expected/cursor/.cursorrules` | Add provenance header, validate against spec |
| `test-fixtures/expected/claude/CLAUDE.md` | Add provenance header, validate against spec |
| `test-fixtures/expected/aider/.aider.conf.yml` | Add provenance header, validate against spec |
| `crates/repo-core/tests/fixture_tests.rs` | Add structural checks alongside string comparison |

## Files to Create

| File | Purpose |
|------|---------|
| `test-fixtures/expected/README.md` | Golden file maintenance rules |

---

## Dependencies

- **Depends on**: [Phase 3](2026-02-22-test-health-phase3-format-validation.md) (format validators provide the knowledge of what's correct)
- **Blocks**: Nothing directly
- **Can parallelize with**: [Phase 5](2026-02-22-test-health-phase5-tautological-tests.md) (if Phase 3 is complete)

---

## Cross-References

- **Source finding**: [Test Health Audit TH-4](../audits/2026-02-22-test-health-audit.md#finding-th-4-self-referential-golden-files)
- **Current golden files**: `test-fixtures/expected/` directory
- **Current tests**: `crates/repo-core/tests/fixture_tests.rs:107-168`
- **Tool research**: [Cursor research](../research/), [Aider research](../research/) — format expectations
- **Related task**: [P3 Test Hygiene](../tasks/P3-test-hygiene.md) — broader test cleanup
- **Chain**: Phase 4 of 5 — prev: [Phase 3](2026-02-22-test-health-phase3-format-validation.md), next: [Phase 5](2026-02-22-test-health-phase5-tautological-tests.md)

---

*Plan created: 2026-02-22*
